<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Recorder - Auth</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .modal { background: #1e1e1e; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 400px; }
        .hidden { display: none; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; }
        #status { margin-top: 20px; color: #aaa; font-size: 14px; }
        video { width: 100%; border-radius: 10px; margin-top: 15px; background: #000; }
    </style>
</head>
<body>

<div id="setup-screen" class="modal">
    <h2>Configuração</h2>
    <p>Para funcionar no Whiteboard, precisamos ativar o áudio e a tela.</p>
    <button id="initBtn">ATIVAR SISTEMA</button>
    <div id="status">Aguardando interação...</div>
</div>

<div id="recorder-screen" class="modal hidden">
    <h3>Gravador Pronto</h3>
    <video id="preview" autoplay muted playsinline></video>
    <button id="startBtn" style="background: #28a745; margin-top: 15px;">INICIAR GRAVAÇÃO</button>
    <button id="stopBtn" class="hidden" style="background: #dc3545; margin-top: 15px;">PARAR E SALVAR</button>
</div>

<script>
    const setupScreen = document.getElementById('setup-screen');
    const recorderScreen = document.getElementById('recorder-screen');
    const initBtn = document.getElementById('initBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    const preview = document.getElementById('preview');

    let finalStream;
    let mediaRecorder;
    let chunks = [];

    // 1. O PRIMEIRO CLIQUE: Acorda as APIs de Mídia
    initBtn.onclick = async () => {
        statusDiv.innerText = "Solicitando microfone...";
        try {
            // Isso dispara o pop-up de permissão de áudio do Android
            const micStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, noiseSuppression: false } 
            });
            
            statusDiv.innerText = "Microfone OK! Aguardando Tela...";
            
            // Agora que o microfone foi aceito, liberamos a interface de gravação
            setupScreen.classList.add('hidden');
            recorderScreen.classList.remove('hidden');
            
            // Guardamos o stream do mic para usar depois
            window.localMicStream = micStream;

        } catch (err) {
            alert("Erro de permissão: " + err.name + "\nCertifique-se de estar em HTTPS e de ter autorizado o Chrome no Android.");
            statusDiv.innerText = "Erro: " + err.message;
        }
    };

    // 2. O SEGUNDO CLIQUE: Inicia a captura de tela e gravação
    startBtn.onclick = async () => {
        try {
            // Dispara o pop-up de captura de tela do Android
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                video: true,
                audio: false // No Android 14, áudio interno via browser é instável, usamos o mic aberto
            });

            // Mixagem
            const audioCtx = new AudioContext();
            const dest = audioCtx.createMediaStreamDestination();
            const source = audioCtx.createMediaStreamSource(window.localMicStream);
            source.connect(dest);

            finalStream = new MediaStream([
                ...screenStream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            preview.srcObject = finalStream;
            
            mediaRecorder = new MediaRecorder(finalStream, { mimeType: 'video/webm;codecs=vp8' });
            chunks = [];
            
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gravacao_whiteboard.webm';
                a.click();
            };

            mediaRecorder.start();
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');

        } catch (err) {
            alert("Erro na captura de tela: " + err.message);
        }
    };

    stopBtn.onclick = () => {
        mediaRecorder.stop();
        finalStream.getTracks().forEach(t => t.stop());
        window.localMicStream.getTracks().forEach(t => t.stop());
        location.reload(); // Reseta para nova gravação
    };
</script>
</body>
</html>
