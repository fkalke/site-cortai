<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Recorder - Estilo Meet</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        video { width: 100%; max-width: 600px; border-radius: 8px; background: #000; margin-bottom: 1rem; }
        .controls { display: flex; gap: 10px; justify-content: center; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #startBtn { background-color: #0d6efd; color: white; }
        #stopBtn { background-color: #dc3545; color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .status { margin-top: 1rem; font-size: 0.9rem; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>Gravador de Tela + Áudio Mixado</h2>
    <video id="preview" autoplay muted></video>
    <div class="controls">
        <button id="startBtn">Iniciar Gravação</button>
        <button id="stopBtn" disabled>Parar e Salvar</button>
    </div>
    <div id="status" class="status">Aguardando início...</div>
</div>

<script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const preview = document.getElementById('preview');
    const statusDiv = document.getElementById('status');

    let mediaRecorder;
    let recordedChunks = [];

    startBtn.onclick = async () => {
        try {
            // 1. Captura a tela (pede áudio do sistema)
            const screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: true
            });

            // 2. Captura o microfone
            const micStream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: true, noiseSuppression: true }
            });

            // 3. Mixagem usando Web Audio API
            const audioCtx = new AudioContext();
            const destination = audioCtx.createMediaStreamDestination();

            // Adiciona sistema ao mix
            if (screenStream.getAudioTracks().length > 0) {
                const systemSource = audioCtx.createMediaStreamSource(screenStream);
                systemSource.connect(destination);
            } else {
                console.warn("Áudio do sistema não compartilhado!");
                statusDiv.innerText = "Aviso: Gravando sem áudio do sistema.";
            }

            // Adiciona microfone ao mix
            const micSource = audioCtx.createMediaStreamSource(micStream);
            micSource.connect(destination);

            // 4. Cria o stream final combinado
            const tracks = [
                ...screenStream.getVideoTracks(),
                ...destination.stream.getAudioTracks()
            ];
            const combinedStream = new MediaStream(tracks);

            // Preview visual
            preview.srcObject = combinedStream;

            // 5. Configura o Recorder
            mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm;codecs=vp8,opus' });
            recordedChunks = [];

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);

                // Download automático
                const a = document.createElement('a');
                a.href = url;
                a.download = `gravacao_${new Date().getTime()}.webm`;
                a.click();

                // Limpa os tracks para fechar a luz de "gravando" do navegador
                combinedStream.getTracks().forEach(track => track.stop());
                statusDiv.innerText = "Gravação concluída e salva!";
            };

            mediaRecorder.start();

            startBtn.disabled = true;
            stopBtn.disabled = false;
            statusDiv.innerText = "Gravando agora (Tela + Mic + Sistema)...";

        } catch (err) {
            console.error("Erro ao iniciar:", err);
            statusDiv.innerText = "Erro: " + err.message;
        }
    };

    stopBtn.onclick = () => {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
    };
</script>

</body>
</html>